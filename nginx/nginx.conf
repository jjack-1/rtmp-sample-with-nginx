# alfg/nginx-rtmp ìµœì í™” ì„¤ì • íŒŒì¼
daemon off;
error_log /dev/stdout info;

# ì´ë²¤íŠ¸ ì²˜ë¦¬ ëª¨ë“ˆ
events {
    worker_connections 1024;
    use epoll;                    # Linux ìµœì í™”
}

# RTMP ì„œë²„ ì„¤ì •
rtmp {
    server {
        listen 1935;                      # RTMP ì…ë ¥ í¬íŠ¸
        chunk_size 4000;                  # ë„¤íŠ¸ì›Œí¬ ì„±ëŠ¥ ìµœì í™”
        
        # âœ… í”ŒëŸ¬í„° ì•± í˜¸í™˜ì„ ìœ„í•œ live ì• í”Œë¦¬ì¼€ì´ì…˜
        application live {
            live on;                    # ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”
            
            # âœ… FFmpeg í˜¸í™˜ì„±ì„ ìœ„í•œ ì˜¬ë°”ë¥¸ ê¶Œí•œ ì„¤ì •
            allow play 127.0.0.1;       # FFmpeg(ë¡œì»¬í˜¸ìŠ¤íŠ¸)ë§Œ ì¬ìƒ í—ˆìš©
            deny play all;              # ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ ì¬ìƒ ì°¨ë‹¨
            
            # âœ… ë‹¤ì¤‘ í•´ìƒë„ FFmpeg íŠ¸ëœìŠ¤ì½”ë”© (60fpsì— ë§ê²Œ ë¹„íŠ¸ë ˆì´íŠ¸ ìƒí–¥ ì¡°ì •)
            exec sh -c '
                # 1. ë‹¤ì¤‘ í™”ì§ˆ íŠ¸ëœìŠ¤ì½”ë”©ì„ ë°±ê·¸ë¼ìš´ë“œ(&)ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
                ffmpeg -i rtmp://localhost:1935/live/$name \
                    -c:v libx264 -b:v 6000k -maxrate 6000k -bufsize 12000k -vf scale=1920:1080 -r 60 -g 120 -keyint_min 120 -preset fast -profile:v high -level 4.2 -c:a aac -b:a 192k -ar 44100 -ac 2 -f flv rtmp://localhost:1935/hls/${name}_1080p \
                    -c:v libx264 -b:v 4000k -maxrate 4000k -bufsize 8000k -vf scale=1280:720 -r 60 -g 120 -keyint_min 120 -preset superfast -profile:v high -level 4.2 -c:a aac -b:a 128k -ar 44100 -ac 2 -f flv rtmp://localhost:1935/hls/${name}_720p \
                    -c:v libx264 -b:v 1200k -maxrate 1200k -bufsize 2400k -vf scale=854:480 -r 30 -g 60 -keyint_min 60 -preset superfast -profile:v baseline -c:a aac -b:a 128k -ar 44100 -ac 2 -f flv rtmp://localhost:1935/hls/${name}_480p &

                # 2. ì¸ë„¤ì¼ ìƒì„±ì„ 1ì‹œê°„ ì£¼ê¸°ë¡œ ë°˜ë³µí•˜ëŠ” ë£¨í”„ë¥¼ ë³„ë„ì˜ ë°±ê·¸ë¼ìš´ë“œ(&) í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
                (while true; do
                    # 2-1. FFmpegìœ¼ë¡œ ì¸ë„¤ì¼ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
                    ffmpeg -i rtmp://localhost:1935/live/$name -vframes 1 -vf scale=1280:720 -y /opt/data/thumbnails/$name.jpg && \

                    # 2-2. ì¸ë„¤ì¼ ìƒì„±ì´ ì„±ê³µí•˜ë©´(&&), ìŠ¤í”„ë§ ì„œë²„ì— JSON í˜•ì‹ìœ¼ë¡œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
                    # ğŸ’¡ ì¤‘ìš”: ì•„ë˜ YOUR_NGINX_SERVER_IP ì™€ YOUR_SPRING_SERVER_IPëŠ” ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                    curl -X PUT \
                            -H "Content-Type: application/json" \
                            -d "{\"thumbnailUrl\":\"http://192.168.0.31/thumbnails/${name}.jpg\"}" \
                            http://192.168.0.31:8080/rtmp/$name/thumbnails;

                    # 2-3. ë‹¤ìŒ ê°±ì‹ ê¹Œì§€ 1ì‹œê°„(3600ì´ˆ) ë™ì•ˆ ëŒ€ê¸°í•©ë‹ˆë‹¤.
                    sleep 3600;
                done) &
            ';
        }
        
        # âœ… HLS ì¶œë ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ (FFmpeg íŠ¸ëœìŠ¤ì½”ë”© ê²°ê³¼ ìˆ˜ì‹ )
        application hls {
            live on;                      # ë¼ì´ë¸Œ í™œì„±í™”
            
            # ì™¸ë¶€ ë°œí–‰ ì°¨ë‹¨ (ë‚´ë¶€ FFmpegë§Œ í—ˆìš©)
            allow publish 127.0.0.1;      # ë¡œì»¬í˜¸ìŠ¤íŠ¸ë§Œ í—ˆìš©
            deny publish all;             # ì™¸ë¶€ ë°œí–‰ ì°¨ë‹¨
            
            # âœ… HLS ì„¤ì • ìµœì í™”
            hls on;                       # HLS ì¶œë ¥ í™œì„±í™”
            hls_path /opt/data/hls;       # HLS ì„¸ê·¸ë¨¼íŠ¸ ì €ì¥ ê²½ë¡œ
            hls_fragment 5;               # 5ì´ˆ ì„¸ê·¸ë¨¼íŠ¸ (ì•ˆì •ì„±)
            hls_playlist_length 10;       # 10ì´ˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (2ê°œ ì„¸ê·¸ë¨¼íŠ¸)
            hls_fragment_naming system;   # ì‹œìŠ¤í…œ ê¸°ë°˜ íŒŒì¼ëª…
            hls_nested on;                # ìŠ¤íŠ¸ë¦¼ë³„ ë””ë ‰í† ë¦¬ ìƒì„±
            
            # âœ… ë‹¤ì¤‘ í™”ì§ˆ ë³€í˜• ì •ì˜ (3ê°œ í™”ì§ˆ í¬í•¨)
            hls_variant _1080p BANDWIDTH=6192000,RESOLUTION=1920x1080; # 6000k(ë¹„ë””ì˜¤) + 192k(ì˜¤ë””ì˜¤)
            hls_variant _720p BANDWIDTH=4128000,RESOLUTION=1280x720;  # 4000k(ë¹„ë””ì˜¤) + 128k(ì˜¤ë””ì˜¤)
            hls_variant _480p BANDWIDTH=1328000,RESOLUTION=854x480;
        }
    }
}

# HTTP ì„œë²„ ì„¤ì • (HLS íŒŒì¼ ì œê³µ)
http {
    # ê¸°ë³¸ MIME íƒ€ì… ì„¤ì •
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # âœ… ì„±ëŠ¥ ìµœì í™” ì„¤ì •
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;
    
    # âœ… ë¡œê·¸ ì„¤ì •
    access_log /dev/stdout combined;
    error_log /dev/stdout warn;
    
    server {
        listen 80;                        # HTTP í¬íŠ¸
        
        # âœ… HLS ìŠ¤íŠ¸ë¦¼ ì œê³µ (CORS ì„¤ì • í¬í•¨)
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;  # HLS í”Œë ˆì´ë¦¬ìŠ¤íŠ¸
                video/mp2t ts;                       # HLS ì„¸ê·¸ë¨¼íŠ¸
            }
            
            root /opt/data;               # alfg/nginx-rtmp ê¸°ë³¸ ê²½ë¡œ
            
            # CORS ë° ìºì‹œ ì„¤ì • (ì›¹ í”Œë ˆì´ì–´ ì§€ì›)
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
            add_header Access-Control-Allow-Headers Range;
        }

        # âœ… ì¸ë„¤ì¼ ì œê³µì„ ìœ„í•œ ê²½ë¡œ (ì¶”ê°€ë¨)
        location /thumbnails {
            root /opt/data;
            expires 7d;
            add_header Access-Control-Allow-Origin *;
        }
        
        # âœ… í¸ì˜ìš© ë³„ì¹­ (ì„ íƒì‚¬í•­)
        location /live {
            alias /opt/data/hls;
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }
        
        # âœ… ì„œë²„ ìƒíƒœ ëª¨ë‹ˆí„°ë§ í˜ì´ì§€
        location /stat {
            rtmp_stat all;               # RTMP í†µê³„ í‘œì‹œ
            rtmp_stat_stylesheet stat.xsl;
        }
        
        # âœ… í†µê³„ ìŠ¤íƒ€ì¼ì‹œíŠ¸
        location /stat.xsl {
            root /www/static;            # alfg/nginx-rtmp ê¸°ë³¸ ê²½ë¡œ
        }
        
        # âœ… crossdomain.xml ì§€ì› (Flash í˜¸í™˜ì„±)
        location /crossdomain.xml {
            default_type text/xml;
            expires 24h;
        }
        
        # âœ… ê¸°ë³¸ í˜ì´ì§€
        location / {
            root /www/static;
            index index.html;
        }
    }
}
